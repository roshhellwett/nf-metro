%%metro title: WGS/WES Variant Pipeline
%%metro style: dark
%%metro line: wgs | Whole Genome | #2db572
%%metro line: wes | Whole Exome | #0570b0

graph LR
    subgraph input_qc [Input & QC]
        iq_input[Input]
        iq_fastqc[FastQC]
        iq_trim[Trim]
        iq_filter[Filter]

        iq_input -->|wgs,wes| iq_fastqc
        iq_fastqc -->|wgs,wes| iq_trim
        iq_trim -->|wgs,wes| iq_filter
    end

    subgraph alignment [Alignment]
        al_bwa[BWA-MEM2]
        al_sort[Sort]
        al_dedup[Dedup]
        al_bqsr[BQSR]

        al_bwa -->|wgs,wes| al_sort
        al_sort -->|wgs,wes| al_dedup
        al_dedup -->|wgs,wes| al_bqsr
    end

    subgraph base_recal [Base Recalibration]
        br_recal[Recalibrate]
        br_apply[Apply]
        br_validate[Validate]
        br_index[Index]

        br_recal -->|wgs,wes| br_apply
        br_apply -->|wgs,wes| br_validate
        br_validate -->|wgs,wes| br_index
    end

    subgraph calling [Variant Calling]
        vc_hc[HaplotypeCaller]
        vc_genotype[Genotype]
        vc_merge[Merge VCF]
        vc_norm[Normalize]

        vc_hc -->|wgs,wes| vc_genotype
        vc_genotype -->|wgs,wes| vc_merge
        vc_merge -->|wgs,wes| vc_norm
    end

    subgraph hard_filter [Hard Filtering]
        hf_sel_snp[Select SNPs]
        hf_sel_indel[Select Indels]
        hf_filt_snp[Filter SNPs]
        hf_filt_indel[Filter Indels]

        hf_sel_snp -->|wgs,wes| hf_filt_snp
        hf_filt_snp -->|wgs,wes| hf_sel_indel
        hf_sel_indel -->|wgs,wes| hf_filt_indel
    end

    subgraph annotation [Annotation]
        an_vep[VEP]
        an_snpsift[SnpSift]
        an_classify[Classify]
        an_prioritize[Prioritize]

        an_vep -->|wgs,wes| an_snpsift
        an_snpsift -->|wgs,wes| an_classify
        an_classify -->|wgs,wes| an_prioritize
    end

    subgraph interpretation [Interpretation]
        ip_pathogenicity[Pathogenicity]
        ip_frequency[Frequency]
        ip_clinical[Clinical]
        ip_aggregate[Aggregate]

        ip_pathogenicity -->|wgs,wes| ip_frequency
        ip_frequency -->|wgs,wes| ip_clinical
        ip_clinical -->|wgs,wes| ip_aggregate
    end

    subgraph integration [Integration]
        ig_merge[Merge Calls]
        ig_validate[Validate]
        ig_qc[QC Check]
        ig_finalize[Finalize]

        ig_merge -->|wgs,wes| ig_validate
        ig_validate -->|wgs,wes| ig_qc
        ig_qc -->|wgs,wes| ig_finalize
    end

    subgraph reporting [Reporting]
        rp_summary[Summary]
        rp_multiqc[MultiQC]
        rp_report[Report]

        rp_summary -->|wgs,wes| rp_multiqc
        rp_multiqc -->|wgs,wes| rp_report
    end

    subgraph archival [Archival]
        ar_archive[Archive]
        ar_compress[Compress]

        ar_archive -->|wgs,wes| ar_compress
    end

    iq_filter -->|wgs,wes| al_bwa
    al_bqsr -->|wgs,wes| br_recal
    br_index -->|wgs,wes| vc_hc
    vc_norm -->|wgs,wes| hf_sel_snp
    hf_filt_indel -->|wgs,wes| an_vep
    an_prioritize -->|wgs,wes| ip_pathogenicity
    ip_aggregate -->|wgs,wes| ig_merge
    ig_finalize -->|wgs,wes| rp_summary
    rp_report -->|wgs,wes| ar_archive
